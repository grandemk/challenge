#define _GNU_SOURCE

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

#include <string.h>

int
main(int argc, char ** argv)
{
  char * make_path = "/home/exploit05/project/make";
  char * path_prefix = "/home/exploit05/project/";

  /* Checking if there is an argument, fail if not */
  if (argc < 2)
    {
      fprintf (stderr,
	       "safe-run: error: missing argument\n"
	       "usage: safe-run MAKEFILE_PATH\n");
      exit(EXIT_FAILURE);
    }

  /* Check if the given path has '..' inside */
  if (strstr(argv[1], ".."))
    {
      fprintf (stderr,
	       "safe-run: detected an attempt to escape the directory !\n");
      exit(EXIT_FAILURE);
    }

  /* Concatenate path_prefix and argv[1] */
  char *makefile_path = malloc(strlen(path_prefix) + strlen(argv[1]) + 1);

  strcpy(makefile_path, path_prefix);
  strcat(makefile_path, argv[1]);

  printf("command: %s -f %s\n", make_path, makefile_path);

  /* Calling execve() */
  char * args[4] = { make_path, "-f", makefile_path, 0 };
  char * envp[1] = { 0 };

  execve(make_path, args, envp);

  /* In case the execve is failing */
  return EXIT_FAILURE;
}
